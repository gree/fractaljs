{"version":3,"file":"fractal.js","sources":["../src/pubsub.js","../src/component.js","../src/index.js"],"sourcesContent":["let topics = {}, seq = 0;\n\nexport default {\n  publish: function(topic, data, publisher) {\n    console.debug(\"publish\", topic);\n    let subscribers = topics[topic];\n    for (let i in subscribers)\n      subscribers[i].cb(topic, data, publisher);\n  },\n  subscribe: function(topic, cb, subscriber) {\n    console.debug(\"subscribe\", topic);\n    if (!topics[topic])\n      topics[topic] = [];\n    let token = ++seq;\n    topics[topic].push({\n      token: token,\n      subscriber: subscriber,\n      cb: cb\n    });\n    return token;\n  },\n  unsubscribe: function(topic, token) {\n    console.debug(\"unsubscribe\", topic);\n    if (!(topic in topics))\n      return;\n    let subscribers = topics[topic];\n    for (let i in subscribers) {\n      if (subscribers[i].token === token) {\n        subscribers.splice(i, 1);\n        break;\n      }\n    }\n    if (subscribers.length === 0)\n      delete topics[topic];\n  },\n  getSubscribers: function(topic) {\n    if (!(topic in topics))\n      return [];\n    return topics[topic].map(v => { return v.subscriber; });\n  },\n};\n","import Pubsub from './pubsub'\n\nconst COMPONENT_ATTR = 'f-component'\nconst knownComponents = {}\n\nexport class Component {\n  constructor(name, el, parent) {\n    this.name = name;\n    this.el = el;\n    this.complete = false;\n    this.parent = parent;\n    this.children = [];\n    this.subTokens = {};\n  }\n\n  getData(cb, param) {\n    cb(this.data || {});\n  }\n\n  render(data, template, param) {\n    this.el.innerHTML = template(data);\n    this.children.forEach(c => {\n      c.destroyed(param);\n    });\n    this.children = [];\n  }\n\n  loadChildren(cb, param) {\n    const els = this.el.querySelectorAll('[' + COMPONENT_ATTR + ']');\n    if (!els || !els.length) {\n      if (cb) cb();\n      return;\n    }\n\n    const len = els.length;\n    let nbComplete = 0;\n    Array.prototype.forEach.call(els, (el, i) => {\n      const name = el.getAttribute(COMPONENT_ATTR);\n      console.log(\"load component:\", name);\n      const Class = knownComponents[name];\n      const c = new Class(name, el, this);\n      this.children.push(c);\n      c.load(param, () => {\n        if (++nbComplete === len) {\n          if (cb) cb();\n        }\n      });\n    });\n  }\n\n  destroyed(param) {\n    this.children.forEach(c => {\n      c.destroyed(param);\n    });\n    this.children = [];\n    console.debug(this.name, \"destroyed\");\n    for (let topic in this.subTokens)\n      Pubsub.unsubscribe(this.subTokens[topic]);\n  }\n\n  rendered(cb, param) {\n    if (cb) cb();\n  }\n  loaded(param){}\n\n  load(param, cb) {\n    param = param || {};\n    console.time('Component.' + this.name);\n    this.complete = false;\n    this.getData(data => {\n      console.log(this.name, data);\n      const template = this.template || require('./' + (this.templateName || this.name) + '.tmpl');\n      this.render(data, template, param);\n      this.rendered(() => {\n        this.loadChildren(() => {\n          this.complete = true;\n          console.timeEnd('Component.' + this.name);\n          this.loaded(param);\n          if (cb) cb();\n        }, param)\n      }, param);\n    }, param)\n  }\n\n  publish(topic, data) {\n    Pubsub.publish(topic, data, this);\n  }\n\n  subscribe(topic, cb) {\n    this.subTokens[topic] = Pubsub.subscribe(topic, cb, this);\n  }\n}\n\nclass Root extends Component {\n  constructor(el) {\n    super('', el, null);\n  }\n}\n\nexport function build(el, param) {\n  const root = new Root(el);\n  root.loadChildren(() => {}, param);\n}\n\nexport function registerComponent(name, component) {\n  knownComponents[name] = component;\n}\n","import {Component, build, registerComponent} from './component'\nimport Pubsub from './pubsub'\n\nfunction createComponent(name, def) {\n  registerComponent(name, class extends Component {\n    constructor(name, el, parent) {\n      super(name, el, parent);\n      if (def.template) {\n        this.template = def.template;\n      }\n      if (def.init) {\n        def.init.bind(this)();\n      }\n      if (def.getData) {\n        this.getData = def.getData.bind(this);\n      }\n      if (def.rendered) {\n        this.rendered = def.rendered.bind(this);\n      }\n    }\n  });\n}\n\nwindow.onpopstate = function () {\n  Pubsub.publish(\"onpopstate\", location.hash);\n};\n\nexport default {\n  build: build,\n  component: createComponent,\n}\n"],"names":["topics","seq","topic","data","publisher","debug","subscribers","i","cb","subscriber","token","push","splice","length","map","v","COMPONENT_ATTR","knownComponents","Component","name","el","parent","complete","children","subTokens","param","template","innerHTML","forEach","destroyed","els","querySelectorAll","len","nbComplete","prototype","call","getAttribute","log","Class","c","load","unsubscribe","time","getData","require","templateName","render","rendered","loadChildren","timeEnd","loaded","publish","Pubsub","subscribe","Root","build","root","registerComponent","component","createComponent","def","init","bind","window","onpopstate","location","hash"],"mappings":"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"}